%consult('/Users/mr.blissfulgrin/Documents/UAH_2018_2019/RAZONAMIENTO/LAB/PECL1/exe.pl').
:-consult('./knoledge_base.pl').
:-consult('./preguntas.pl').

%Inicio del programa
akinator:-
    caracteristicas(ListaPreguntas),length(ListaPreguntas,LongitudPreguntas),
    crearListaRespuestas(n,LongitudPreguntas,ListaRespuestas),lenguajes(ListaLenguajes),
    write('Init'),
    send(S,'%'),send(S,'Akinator!!!'),
    gameLoop(ListaPreguntas,ListaRespuestas,ListaLenguajes,0),
    send(S,'%'),send(S,'Game Over!!!'),!.

%Bucle del juego
gameLoop([PrimeraPregunta|RestoPreguntas],ListaRespuestas,ListaLenguajes,Indice):-
    send(S,'@'),send(S,'�Su lenguaje 'send(S,d(PrimeraPreguntasend(S,d('?'),
    receive(S,Answer),
    (Answer==e -> send(S,'%'), send(S,'exit'),! ;
                 reemplazar(ListaRespuestas,Indice,Answer,NuevaListaRespuestas),
                 send(S,'$'), send(S,NuevaListaRespuestas),
                 Indice1 is Indice+1,
                 validar(NuevaListaRespuestas,ListaLenguajes,[],NuevaListaLenguajes),
                 send(S,'#'),send(S,NuevaListaLenguajes),
                 length(NuevaListaLenguajes,LongitudLenguajes),
                 (LongitudLenguajes=:=1 ->
                          send(S,'%'),send(S,'Su lenguaje es '),[Solucion|_]=NuevaListaLenguajes,
                          send(S,Solucion),!;
                          (LongitudLenguajes=:=0 ->
                                    send(S,'%'),send(S,'No se ha podido encontrar su lenguaje'),
                                    send(S,'@'),send(S,'�Quiere introducir un lenguaje nuevo?'),
                                    receive(S,IntroducirL),
                                    (IntroducirL=:=1 ->
                                                      send(S,'@'),send(S,'Escriba el nombre del lenguaje'),
                                                      receive(S,NombreNuevo),
                                                      caracteristicas(ListaPreguntas),
                                                      send(S,'%'),send(S,'Deber� contestar unas respuestas extra!'),
                                                      completarRespuestas(ListaPreguntas,NuevaListaRespuestas,[],ListaGuardar),
                                                      meterLenguaje(NombreNuevo, ListaGuardar),!;
                                                      send(S,'%'),send(S,'Habr�a sido bueno colaborar!!!'),!);
                          gameLoop(RestoPreguntas,NuevaListaRespuestas,NuevaListaLenguajes,Indice1)))).

gameLoop(_,_,_,_):-send(S,'%'),send(S,'No quedan preguntas').

%Funci�n para rellenar la lista de respuestas al introducir un nuevo lenguaje
completarRespuestas([PrimeraPregunta|RestoPreguntas],[PrimeraRespuesta|RestoRespuestas],ListaGuardar,ListaRetorno):-
    (PrimeraRespuesta==n->
                           send(S,'@'),send(S,'�Su lenguaje 'send(S,d(PrimeraPreguntasend(S,d('?'),
                           receive(S,Respuesta),
                           send(S,'$'),send(S,ListaGuardar),nl,
                           completarRespuestas(RestoPreguntas,RestoRespuestas,[Respuesta|ListaGuardar],ListaRetorno);
                           completarRespuestas(RestoPreguntas,RestoRespuestas,[PrimeraRespuesta|ListaGuardar],ListaRetorno)).

completarRespuestas(_,_,ListaGuardar,ListaGuardar).

%Comparar caracteristicas y quitar lenguaje de la lista general
validar(ListaRespuestas,[Lenguaje1|RestoLenguajes],FinalAnterior,Final):-
    lenguaje(Lenguaje1,ListaCaract),
    validarAux(ListaRespuestas,ListaCaract,Lenguaje1,FinalAnterior,Resultado),
    validar(ListaRespuestas,RestoLenguajes,Resultado,Final).

validar(_,_,FinalAnterior,FinalAnterior).

validarAux([Respuesta1|RestoRespuestas],[Caracteristica1|RestoCaracteristicas],Lenguaje1,FinalAnterior,Final):-
    ((Respuesta1==n;Caracteristica1==n)->
                      validarAux(RestoRespuestas,RestoCaracteristicas,Lenguaje1,FinalAnterior,Final);
                      (Respuesta1==Caracteristica1 ->
                                   validarAux(RestoRespuestas,RestoCaracteristicas,Lenguaje1,FinalAnterior,Final);
                                   validarAux([],[],FinalAnterior,Final))).

validarAux(_,_,Lenguaje1,FinalAnterior,[Lenguaje1|FinalAnterior]).
validarAux(_,_,FinalAnterior,FinalAnterior).

%Reemplazar valor de una lista en una cierta posici�n
reemplazar([_|Cola], 0, Valor, [Valor|Cola]).
reemplazar([Cabeza|Cola1], Indice, Valor, [Cabeza|Cola2]):-
    Indice > -1,
    NuevoIndice is Indice-1,
    reemplazar(Cola1, NuevoIndice, Valor, Cola2), !.
reemplazar(Lista, _, _, Lista).

%Construir lista de longitud N con valor X en sus posiciones
crearListaRespuestas(Valor, Longitud, ListaRespuestas)  :-
    length(ListaRespuestas, Longitud),
    maplist(=(Valor), ListaRespuestas).

%Funci�n que devuelve una lista con nombres de los lenguajes
lenguajes(Lenguajes):- lenguajes_aux([], Lenguajes).
lenguajes_aux(Lenguajes,Resultado):-
    lenguaje(NuevoLenguaje,_),
    not(member(NuevoLenguaje,Lenguajes)),
    lenguajes_aux([NuevoLenguaje|Lenguajes], Resultado), !.
lenguajes_aux(X,X).

%Funcion para insertar lenguaje en la base de conocimiento
meterLenguaje(NombreLenguaje, Caracteristicas):-
    send(S,'%'),
    send(S,'Guaradando el lenguaje '),
    send(S,NombreLenguaje),
    send(S,' con las respuestas:'),
    send(S,Caracteristicas),
    assertz(lenguaje(NombreLenguaje,Caracteristicas)),
    tell('./knoledge_base.pl'),
    listing(lenguaje),
    told,
    send(S,'Guardado!!!').

%Recibir datos del socket UDP
receive(S,Data) :-
        udp_socket(S),
        tcp_bind(S, 5009),
        udp_receive(S,S, Data, _, [as(atom)]),
	write(Data),
        tcp_close_socket(S).

%Enviar datos al socket UDP
send(S,Message) :-
	write(Message),
        udp_send(S,S, Message, localhost:5008, []),
        tcp_close_socket(S).

